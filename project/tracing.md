# Tracing Implementation in SPF Converter

This document outlines the tracing implementation within the `spf-converter` project, utilizing OpenTelemetry for distributed tracing.

## How Tracing is Implemented

The project uses the `opentelemetry` library to instrument the FastAPI application and export traces. The core setup is located in `api/tracing.py`.

Key components:
- **OpenTelemetry SDK**: Provides the necessary APIs and SDKs for tracing.
- **`TracerProvider`**: Manages `Tracer` instances, which are used to create `Span` objects.
- **`OTLPSpanExporter`**: Exports spans in the OpenTelemetry Protocol (OTLP) format. By default, it attempts to send traces to `localhost:4317` (gRPC) or `localhost:4318` (HTTP/protobuf), which is the default endpoint for OpenTelemetry Collector.
- **`BatchSpanProcessor`**: Processes and batches spans before exporting them, improving performance.
- **`FastAPIInstrumentor`**: Automatically instruments the FastAPI application to create spans for incoming requests.

The `setup_tracing` function in `api/tracing.py` initializes the tracing configuration:

```python
from opentelemetry import trace
from opentelemetry.sdk.resources import Resource
from opentelemetry.sdk.trace import TracerProvider
from opentelemetry.sdk.trace.export import BatchSpanProcessor
from opentelemetry.exporter.otlp.proto.grpc.trace_exporter import OTLPSpanExporter
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor

def setup_tracing(app):
    service_name = "spf-converter-api"

    resource = Resource.create(attributes={
        "service.name": service_name,
        "service.instance.id": "instance-1" # This can be made dynamic
    })

    provider = TracerProvider(resource=resource)
    trace.set_tracer_provider(provider)

    otlp_exporter = OTLPSpanExporter()
    span_processor = BatchSpanProcessor(otlp_exporter)
    provider.add_span_processor(span_processor)

    FastAPIInstrumentor.instrument_app(app)
```

This setup ensures that:
1. A `TracerProvider` is configured with a service name (`spf-converter-api`).
2. Spans are exported using OTLP, typically to an OpenTelemetry Collector.
3. All incoming requests to the FastAPI application are automatically traced.

## Visualization Tools

To visualize the traces generated by the `spf-converter` project, you can use OpenTelemetry-compatible tracing backends. Popular choices include:

### 1. Jaeger

Jaeger is a distributed tracing system released as open source by Uber Technologies. It is used for monitoring and troubleshooting microservices-based distributed systems.

**How to run Jaeger (using Docker):**

The simplest way to run Jaeger for local development is using its all-in-one Docker image:

```bash
docker run -d --name jaeger \
  -e COLLECTOR_OTLP_ENABLED=true \
  -p 16686:16686 \
  -p 4317:4317 \
  -p 4318:4318 \
  jaegertracing/all-in-one:latest
```

- `-p 16686:16686`: Jaeger UI port. Access at `http://localhost:16686`.
- `-p 4317:4317`: OTLP gRPC receiver port (used by `OTLPSpanExporter`).
- `-p 4318:4318`: OTLP HTTP receiver port.

**Configuration for `spf-converter`:**

By default, `OTLPSpanExporter` sends traces to `localhost:4317`. If Jaeger is running with the above Docker command, the `spf-converter` application should automatically send traces to Jaeger without additional configuration.

### 2. Zipkin

Zipkin is a distributed tracing system that helps gather timing data needed to troubleshoot latency problems in microservice architectures.

**How to run Zipkin (using Docker):**

```bash
docker run -d --name zipkin -p 9411:9411 openzipkin/zipkin
```

- `-p 9411:9411`: Zipkin UI port. Access at `http://localhost:9411`.

**Configuration for `spf-converter`:**

To send traces to Zipkin, you would typically need to configure the `OTLPSpanExporter` to point to Zipkin's OTLP endpoint, or use a dedicated Zipkin exporter. However, the current `api/tracing.py` uses `OTLPSpanExporter` which is designed for OpenTelemetry Collector or compatible OTLP receivers.

If you want to use Zipkin directly, you might need to:
1. Run an OpenTelemetry Collector configured to receive OTLP and export to Zipkin.
2. Modify `api/tracing.py` to use a `ZipkinExporter` if available in the OpenTelemetry Python SDK, or configure `OTLPSpanExporter` to send to an OTLP-to-Zipkin converter.

For simplicity and direct compatibility with the current setup, **Jaeger is recommended** as it directly supports OTLP.

## Running the Application with Tracing

1. **Ensure a tracing backend is running**: Start Jaeger (or an OpenTelemetry Collector configured for your preferred backend) using the Docker commands provided above.
2. **Run the `spf-converter` application**: Start your FastAPI application as usual. For example, if `app.py` is the main entry point:
   ```bash
   python app.py
   ```
   or if using `uvicorn`:
   ```bash
   uvicorn api.main:app --reload
   ```
3. **Generate traffic**: Make requests to your `spf-converter` API endpoints.
4. **View traces**: Open the Jaeger UI (e.g., `http://localhost:16686`) in your browser, select `spf-converter-api` as the service, and search for traces. You should see spans representing your API requests and any internal operations that are instrumented.

## Environment Variables

You can configure the OTLP exporter using environment variables, for example:

- `OTEL_EXPORTER_OTLP_ENDPOINT`: Specifies the OTLP endpoint (e.g., `http://localhost:4317`).
- `OTEL_SERVICE_NAME`: Overrides the service name configured in `api/tracing.py`.

Example:
```bash
export OTEL_EXPORTER_OTLP_ENDPOINT="http://my-jaeger-collector:4317"
export OTEL_SERVICE_NAME="my-custom-spf-service"
uvicorn api.main:app --reload
```
